const makeWASocket = require("@whiskeysockets/baileys").default;
const { useMultiFileAuthState } = require("@whiskeysockets/baileys");
const qrcode = require("qrcode-terminal");
const { handleMessage } = require("./handlers");
const { SEARCH_WEBSITES, activatedUsers, adminUsers, downloadCounts, lastDownloadTime, subscribedUsers } = require("./utils");

async function startBot() {
  const { state, saveCreds } = await useMultiFileAuthState("auth_info");
  const sock = makeWASocket({ 
    auth: state,
    printQRInTerminal: true,
    browser: ["Ubuntu", "Chrome", "20.0.04"]
  });

  sock.ev.on("connection.update", (update) => {
    const { connection, lastDisconnect, qr } = update;
    if (qr) {
      console.log("Scan the QR code below to connect to WhatsApp:");
      qrcode.generate(qr, { small: true });
    }
    if (connection === "close") {
      console.log("Connection closed, reconnecting...");
      startBot();
    } else if (connection === "open") {
      console.log("Bot connected successfully to WhatsApp");
    }
  });

  sock.ev.on("creds.update", saveCreds);

  sock.ev.on("messages.upsert", async (m) => {
    const message = m.messages[0];
    if (!message.message) return;
    const text = message.message.conversation || message.message.extendedTextMessage?.text || "";
    const sender = message.key.remoteJid;
    const senderNumber = sender.split("@")[0];

    await handleMessage(sock, text, sender, senderNumber);
  });
}

console.log("Starting Abby Bot...");
console.log("If this is your first time running, scan the QR code to connect to WhatsApp");
startBot().catch(console.error);
